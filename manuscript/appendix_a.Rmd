---
title: "Appendix A - Alternative DSDM formulations"
author:
  - Nick Golding
  - School of BioSciences, University of Melbourne, Parkville VIC, Australia
bibliography: dsdm.bib
csl: mee.csl
output:
  pdf_document:
    toc: true
    toc_depth: 2
  word_document:
    fig_caption: true
    highlight: null
---

```{r knitrOpts, echo = FALSE, cache = FALSE, eval = TRUE}
# set up knitr options
knitr::opts_chunk$set(message = FALSE,
               warning = FALSE,
               eval = FALSE,
               cache = FALSE)
```

# Introduction

This appendix provides notation and, where available, computer code for R packages greta and greta.dynamics [@goldingGretaDynamicsModelling2019; @goldingGretaSimpleScalable2019] to implement the DSDMs proposed in the manuscript *Demographic Species Distribution Models* by Nick Golding.

Note that statistical notation is written in the standard way, with the first line giving the sampling distribution, and subsequent lines defining the variables on whhich they depend, however the code uses the reverse order since in greta those variables must be defined bfore they can be used.

# Basic DSDM

For ease of reference, I repeat the equations and interpretation for the basic presence-absence DSDM presented in the main manuscript. It presents the model in its three parts, each of which can be modified independently. Specification of priors for parameters in the model are not discussed here. See [@goldingGretaSimpleScalable2019] and the website [greta-stats.org](https://greta-stats.org) for general guidance on how to build models with greta.

## Observation model

The observation model for the basic DSDM relates the species' relative abundance (I.e. assumed to be within a multiplicative constant of the true abundance) $\Lambda_i$ at site $i$ to the probability of (observed) presence $p_i$ during a single presence-absence survey, and the presence-absence data are assumed to be independently Bernoulli-distributed following these probabilities as in a presence-absence species distribution model.

Notation:

\begin{align}
y_i &\sim Bernoulli(p_i) \\ \nonumber
p_i &= 1 - e^{-\Lambda_i}
\end{align}

Code:

```{r basic_obs}
p <- 1 - exp(-Lambda)
distribution(y) <- bernoulli(p)
```

Given vectors `Lambda` and `y` each with length `n`, the number of sites.

## Abundance relationship

The abundance relationship relates the transition matrix $\mathbf{A}_i$ of the population at site $i$ to the relative abundance $\Lambda_i$. The intrinsic growth rate $\lambda_i$ of the population is used to compute the theoretical carrying capacity $K_i$ according to the Beverton-Holt model, with competition effect parameter $\alpha$. This theoretical carrying capacity is negative when $\lambda_i < 1$, so it is rectified by the softplus function to always yield a positive abundance $\Lambda_i$, which is close to zero when $\lambda_i < 1$, and approximately equal to $K_i$ when $\lambda_i > 1$.

Notation:

\begin{align}
\Lambda_i &= ln(1 + e^{K_i})  \\ \nonumber
K_i &= (\lambda_i - 1) \alpha \\ \nonumber
\lambda_i &= eigval(\mathbf{A_i})
\end{align}

Code:

```{r basic_abundance}
analysis <- iterate_matrix(A)
lambda <- analysis$lambda
K <- (lambda - 1) * alpha
Lambda <- log1pe(K)
```

Given a 3D array `A` with dimensions `n` x `m` x `m`, where `n` is the number of sites, and `m` the number of stages in the population model (dimension of the matrices $\mathbf{A}_i$), and `alpha` is a scalar. When used with its default settings the function `greta.dynamics::iterate_matrix()` returns, among other quantities, a vector of intrinsic growth rates of the matrices in `A` computed by repeated iteration of the matrix

## Transition matrix and vital rate regressions

The transition matrix $\mathbf{A}_i$ describes the fundamental dynamics of the population at location $i$, with cells expressing the rates of transition from each stage at the previous timestep (columns) to each stage in the present time step (rows). Thus for each adult in the previous time step $F_i \cdot S_{Ai}$ juveniles are contributed to the population in the current time step: each adult survives with probability $S_{Ai}$, and produces an average of $F_i$ offspring, with the product of these giving the expected contribution per adult. For more details of matrix population models such as this, see [@caswellMatrixPopulationModels2001].

Each of these vital rates at each site $i$ is given by a linear model against a design matrix $\mathbf{X}_i$ representing environmental covariates, an intercept (coded as a column of all ones), and any transformations of those covariates

Notation:

\begin{align}
\mathbf{A}_i &= \begin{bmatrix} F_i \cdot S_{Ji} & F_i \cdot S_{Ai} \\ S_{Ji} & S_{Ai}  \end{bmatrix} \\ \nonumber
ln(F_i) &= \mathbf{X}_i\beta_F \\ \nonumber
logit(S_{Ai}) &= \mathbf{X}_i\beta_S \\ \nonumber
logit(S_{Ji}) &= logit(S_{Ai}) - \gamma
\end{align}

Code:

```{r basic_transition}
log_F <- X %*% beta_F
logit_S_A <- X %*% beta_S
F <- exp(log_F)
S_A <- ilogit(logit_S_A)
S_J <- ilogit(logit_S_A - gamma)

top <- cbind(F * S_J, F * S_A)
bottom <- cbind(S_J, S_A)
A <- abind(top, bottom, along = 3)
```

Given an `n` x `k` matrix `X`, length `k` vectors `beta_S` and `beta_F`, and a scalar `gamma`, where `n` is the number of sites and `k` the number of columns (covariates plus an intercept) of the design matrix.

# Alternative observation models

Below I provide alternative observation models for count, and presence-only data. occupancy detection observation models can be implemnted using other greta extension packages, but are byond the scope of this manuscript.

## Poisson count data

The relative abundance variable $Lambda_i$ is the parameter of the poisson distribution, so a poisson count model is simply given by:

Notation:
\begin{align}
y_i &\sim Poisson(\Lambda_i)
\end{align}

Code:
```{r poisson_obs}
distribution(y) <- poisson(Lambda)
```
Where `y` is a vector of counts

## Negative binomial count data

Where count data are overdispersed with respect to the expected counts $\Lambda_i$, this overdispersion can be modelled with a negative binomial distribution as:

Notation:
\begin{align}
p_i &= r / (r + \Lambda_i) \\ \nonumber
y_i &\sim Negative Binomial(r, p_i)
\end{align}
Where the negative binomial is parameterised in terms of dispersion parameter $r$ representing the target number of successful trials, and $p_i$ the probability of success in each trial.

Code:
```{r negbin_obs}
p <- r / (r + Lambda)
distribution(y) <- negative_binomial(r, p)
```
Given a positive scalar `r`, and where y is a vector of counts. `r` and `p` correspond to the `size` and `prob` arguments of `stats::dnbinom` in R.

## Presence-only data

Presence-only data - where records consist of locations where the species has been reported as being present - can be considered as a thinned, inhomogenous Poisson point process [@wartonPoissonPointProcess2010;@rennerPointProcessModels2015]. The likelihood for this model comprises an intractable integral over the study area, which can be approximated in a number of ways that reduce the model to having a Poisson observation model. Here I apply the piecewise constant approximation, defininthe observations $y_i$ to be counts of occurrence records in each cell $i$, having area $a_i$, where the cells represent a partition of the study area [@diggleSpatialSpatioTemporalLogGaussian2013;@simpsonGoingGridComputationally2011]. That is they tesselate (but do not overlap) and together cover the entire study area.
Under this definition, the DSDM relative abundance parameter $\Lambda_i$ represents a density of point observations per unit area (assumed to be homogenous across cell $i$) that *would* be seen if there were no spatial bias in rates of reporting. The expected number of presence-only observations in each cell is therefore the product of the relative abundance $\Lambda_i$, the area $a_i$, and a relative measure of the bias in reporting, $\gamma_i$ (also assumed homogenous across each cell). Values of $\gamma_i$ for each location can be provided as data, or estimated during model-fitting via an additional regression submodel against detection covariates. Since $\Lambda_i$ is only identified to within a multiplicative constant ($\alpha$ in Equation 2), the absolute value of $\gamma_i$ is not identified in this model, so any model for $\gamma_i$ should probably not have an intercept term. 

Notation:
\begin{align}
y_i &\sim Poisson(a_i\gamma_i\Lambda_i)
\end{align}

Code:
```{r ppm_obs}
distribution(y) <- poisson(a * gamma * Lambda)
```
Where `y` gives the number of presence-only records reported in cell $i$ and `a` and `gamma` are vectors giving the areas of the cells, and

## Integrated models

Specification of integrated models (those with multiple likelihoods for different datatypes) is simple, simply by using multiple `distribution()` statements. For example, a a combined presence-absence and abundance model might be defined as:

```{r integrated_obs}
p <- 1 - exp(-Lambda[pa_locations])
distribution(y_pa) <- bernoulli(p)
distribution(y_count) <- poisson(Lambda[count_locations])
```
Where `pa_locations` and `count_locations` are numeric indices to the sites with to presence-absence and count data respectively, and `y_pa` and `y_count` are the corresponding vectors of observed data.

# Alternative abundance relationships

## Ricker model

The abundance relationship in the DSDM presented in the manuscript derives from the Beverton-Holt model, with the carrying capacity $K_i$ proportional to the intrinsic growth rate $\lambda_i$ minus one. This ensures that $K_i$ is zero if $\lambda_i = 1$ (no growth) and increases as lambda increases, though it has the unfortunate consequence that $K_i$ has negative values for $\lambda_i < 1$, which must be rectified in that model. An alternative abundance relationship approach, given in [@pagelForecastingSpeciesRanges2012], derives from the Ricker model and has a linear relationship between $K_i$ and $\lambda_i$, yielding a relative abundance expression that does not need rectifying. Though with large enough $\alpha$, this approach can yield large values of $\Lambda_i$ even if $\lambda_i$ is well below 1, in which  case the species should not be able to persist.

Notation:
\begin{align}
\Lambda_i &= \lambda_i \alpha \\ \nonumber
\lambda_i &= eigval(\mathbf{A_i})
\end{align}

Code:
```{r ricker_abundance}
analysis <- iterate_matrix(A)
lambda <- analysis$lambda
Lambda <- lambda * alpha
```

## Density-dependent vital rates

Both the Ricker and Beverton-Holt approaches to the abundance relationship assume that the carrying capacity can be expressed as some function of the intrinsic growth rate. This is convenient since the intrinsic growth rate is a well-studied and simple to compute quantity of a temporally-static transition matrix $A_i$. However, a more ecologically realistic approach is to explicitly model the vital rates as being density-dependent - that is having the survival probabilities or fecundity rates at a given time point depend on the population density at the previous time point. This enables incorporation of more detailed ecological knowledge about how vital rates drive abundance, which may be important to consider if the answer to the ecological question of interest depends on density dependence.

Density dependent vital rates can be incorporated in a DSDM by explicitly considering a vector $\mathbf{n}_{i,t}$ of population densities for each of $m$ life stages (indexed with $j$) at site $i$, at time $t$. $\mathbf{n}_{i,t}$ is evolved through time by multiplication against a timepoint-specific transition matrix $\mathbf{A}_{i,t}$, contructed of timepoint-specific vital rates that depend on the total population density (i.e. across all life stages $m$) in the previous time point $\mathbf{N}_{i,t}$. For example, these density-dependent relationships could be a linear function of population density (controlled by parameters $\alpha_F$ and $\alpha_S$) on the link-scale of the vital rates. Since the transition matrix is no longer temporally-static, the population dynamics cannot be summarised by a population growth rate. Instead, iteration of the matrix using the density-dependent vital rate functions causes the vector $\mathbf{n}_{i,t}$ of population densities to converge on a static value after a sufficient number of iterations, $T$. This terminal density can be used directly as the relative abundance. As in the basic DSDM, the parameters $\alpha_F$ and $\alpha_S$ control both density-dependence and the detection rate, since these two processes cannot be differentiated without population growth data.

Notation:
\begin{align}
\Lambda_i &=  \mathbf{n}_{i, T} \\ \nonumber
\mathbf{n}_{i,t+1} &= \mathbf{A}_{i,t+1} \mathbf{n}_{i,t} \\ \nonumber
\mathbf{A}_{i,t+1} &= \begin{bmatrix} F_{i,t} \cdot S_{Ji,t} & F_{i,t} \cdot S_{Ai,t} \\ S_{Ji,t} & S_{Ai,t}  \end{bmatrix}  \\ \nonumber
ln(F_{i,t}) &= \mathbf{X}_i \beta_F + \alpha_F \textstyle\sum_{j=1}^m{\mathbf{n}_{i,t,j}}\\ \nonumber
logit(S_{Ai,t}) &= \mathbf{X}_i \beta_S + \alpha_S \textstyle\sum_{j=1}^m{\mathbf{n}_{i,t,j}} \\ \nonumber
logit(S_{Ji,t}) &= logit(S_{Ai,t}) - \gamma
\end{align}

Code:
```{r vital_dd_abundance}
dynamic_A <- function(state, iter, log_F, logit_S, alpha_F, alpha_S, gamma) {
  
  N <- rowSums(state)
  log_F_t <- base_log_F + N * alpha_F
  logit_S_A_t <- base_logit_S + N * alpha_S
  
  F_t <- exp(log_F_t)
  S_A_t <- ilogit(logit_S_A_t)
  S_J_t <- ilogit(logit_S_A_t - gamma)

  top <- cbind(F_t * S_J_t, F_t * S_A_t)
  bottom <- cbind(S_J_t, S_A_t)
  A_t <- abind(top, bottom, along = 3)
  A_t
  
}

analysis <- iterate_dynamic_matrix(
  matrix_function = dynamic_A, 
  base_log_F = X %*% beta_F,
  base_logit_S = X %*% beta_S,
  alpha_F = alpha_F,
  alpha_S = alpha_S,
  gamma = gamma
)

Lambda <- analysis$stable_population
```
Given additional scalar parameters `alpha_F` and `alpha_S`.

# Temporally-varying abundance

## Long-term environmental variation

## Short term environmenatal variation


# Transition matrix models

## Integral projection models

## Multiple species

## Dispersal


# References
