---
title: "Appendix A - Alternative DSDM formulations"
author:
  - Nick Golding
  - School of BioSciences, University of Melbourne, Parkville VIC, Australia
bibliography: dsdm.bib
csl: mee.csl
output:
  pdf_document:
    toc: true
    toc_depth: 2
  word_document:
    fig_caption: true
    highlight: null
---

```{r knitrOpts, echo = FALSE, cache = FALSE, eval = TRUE}
# set up knitr options
knitr::opts_chunk$set(message = FALSE,
               warning = FALSE,
               eval = FALSE,
               cache = FALSE)
```

# Introduction

This appendix provides statistical notation and computer code for the R packages greta and greta.dynamics [@goldingGretaDynamicsModelling2019; @goldingGretaSimpleScalable2019] to implement the broad range of DSDMs proposed in the manuscript *Demographic Species Distribution Models* by Nick Golding.

Note that statistical notation is written in the standard way with the first line giving the sampling distribution, and subsequent lines defining the variables on which previous lines depend, however the code uses the reverse order since in greta variables must be defined before they can be used to create other variables.

# Basic DSDM

For ease of reference, I repeat here the equations and interpretation for the basic presence-absence DSDM presented in the main manuscript. It presents the model in its three parts, each of which can be modified independently. Specification of priors for parameters in the model are not discussed here. See [@goldingGretaSimpleScalable2019] and the website [greta-stats.org](https://greta-stats.org) for general guidance on how to build models with greta.

## Observation model

The observation model for the basic DSDM relates the species' relative abundance (I.e. assumed to be within a multiplicative constant of the true abundance) $\Lambda_i$ at site $i$ to the probability of (observed) presence $p_i$ during a single presence-absence survey, and the presence-absence data are assumed to be independently Bernoulli-distributed following these probabilities as in a presence-absence species distribution model.

Notation:

\begin{align}
y_i &\sim Bernoulli(p_i) \\ \nonumber
p_i &= 1 - e^{-\Lambda_i}
\end{align}

Code:

```{r basic_obs}
p <- 1 - exp(-Lambda)
distribution(y) <- bernoulli(p)
```

Given vectors `Lambda` and `y` each with length $N$, the number of sites.

## Abundance model

The abundance model relates the transition matrix $\mathbf{A}_i$ of the population at site $i$ to the relative abundance $\Lambda_i$. The intrinsic growth rate $\lambda_i$ of the population is used to compute the theoretical carrying capacity $K_i$ according to the Beverton-Holt model, with competition effect parameter $\alpha$. This theoretical carrying capacity is negative when $\lambda_i < 1$, so it is rectified by the softplus function to always yield a positive abundance $\Lambda_i$, which is close to zero when $\lambda_i < 1$, and approximately equal to $K_i$ when $\lambda_i > 1$.

Notation:

\begin{align}
\Lambda_i &= ln(1 + e^{K_i})  \\ \nonumber
K_i &= (\lambda_i - 1) \alpha \\ \nonumber
\lambda_i &= eigval(\mathbf{A}_i)
\end{align}

Code:

```{r basic_abundance}
analysis <- iterate_matrix(A)
lambda <- analysis$lambda
K <- (lambda - 1) * alpha
Lambda <- log1pe(K)
```

Given a 3D array `A` with dimensions $N$x$M$x$M$, where $N$ is the number of sites, and $M$ the number of life stages in the population model (dimension of the matrices $\mathbf{A}_i$), and `alpha` is a scalar. When used with its default settings the function `greta.dynamics::iterate_matrix()` returns, among other quantities, a vector of intrinsic growth rates of the matrices in `A` computed by repeated iteration of the matrix

## Population dynamic model

The transition matrix $\mathbf{A}_i$ describes the fundamental dynamics of the population at location $i$, with cells expressing the rates of transition from each stage at the previous timestep (columns) to each stage in the present time step (rows). Thus for each adult in the previous time step $F_i \cdot S_{Ai}$ juveniles are contributed to the population in the current time step: each adult survives with probability $S_{Ai}$, and produces an average of $F_i$ offspring, with the product of these giving the expected contribution per adult. For more details of matrix population models such as this, see [@caswellMatrixPopulationModels2001].

Each of these vital rates at each site $i$ is given by a linear model against a design matrix $\mathbf{X}_i$ representing environmental covariates, an intercept (coded as a column of all ones), and any transformations of those covariates

Notation:

\begin{align}
\mathbf{A}_i &= \begin{bmatrix} F_i \cdot S_{Ji} & F_i \cdot S_{Ai} \\ S_{Ji} & S_{Ai}  \end{bmatrix} \\ \nonumber
ln(F_i) &= \mathbf{X}_i\beta_F \\ \nonumber
logit(S_{Ai}) &= \mathbf{X}_i\beta_S \\ \nonumber
logit(S_{Ji}) &= logit(S_{Ai}) - \gamma
\end{align}

Code:

```{r basic_transition}
log_F <- X %*% beta_F
logit_S_A <- X %*% beta_S
F <- exp(log_F)
S_A <- ilogit(logit_S_A)
S_J <- ilogit(logit_S_A - gamma)

top <- cbind(F * S_J, F * S_A)
bottom <- cbind(S_J, S_A)
A <- abind(top, bottom, along = 3)
```

Given an $N$x$K$ matrix `X`, length $K$ vectors `beta_S` and `beta_F`, and a scalar `gamma`, where $N$ is the number of sites and $K$ the number of columns (covariates plus an intercept) of the design matrix.

# Observation models

Below I provide alternative observation models for count, and presence-only data. occupancy detection observation models can be implemnted using other greta extension packages, but are byond the scope of this manuscript.

## Poisson count data

The relative abundance variable $Lambda_i$ is the parameter of the poisson distribution, so a poisson count model is simply given by:

Notation:
\begin{align}
y_i &\sim Poisson(\Lambda_i)
\end{align}

Code:
```{r poisson_obs}
distribution(y) <- poisson(Lambda)
```
Where `y` is a vector of counts

## Negative binomial count data

Where count data are overdispersed with respect to the expected counts $\Lambda_i$, this overdispersion can be modelled with a negative binomial distribution as:

Notation:
\begin{align}
p_i &= r / (r + \Lambda_i) \\ \nonumber
y_i &\sim Negative Binomial(r, p_i)
\end{align}
Where the negative binomial is parameterised in terms of dispersion parameter $r$ representing the target number of successful trials, and $p_i$ the probability of success in each trial.

Code:
```{r negbin_obs}
p <- r / (r + Lambda)
distribution(y) <- negative_binomial(r, p)
```
Given a positive scalar `r`, and where y is a vector of counts. `r` and `p` correspond to the `size` and `prob` arguments of `stats::dnbinom` in R.

## Presence-only data

Presence-only data - where records consist of locations where the species has been reported as being present - can be considered as a thinned, inhomogenous Poisson point process [@wartonPoissonPointProcess2010;@rennerPointProcessModels2015]. The likelihood for this model comprises an intractable integral over the study area, which can be approximated in a number of ways that reduce the model to having a Poisson observation model. Here I apply the piecewise constant approximation, defininthe observations $y_i$ to be counts of occurrence records in each cell $i$, having area $a_i$, where the cells represent a partition of the study area [@diggleSpatialSpatioTemporalLogGaussian2013;@simpsonGoingGridComputationally2011]. That is they tesselate (but do not overlap) and together cover the entire study area.
Under this definition, the DSDM relative abundance parameter $\Lambda_i$ represents a density of point observations per unit area (assumed to be homogenous across cell $i$) that *would* be seen if there were no spatial bias in rates of reporting. The expected number of presence-only observations in each cell is therefore the product of the relative abundance $\Lambda_i$, the area $a_i$, and a relative measure of the bias in reporting, $\gamma_i$ (also assumed homogenous across each cell). Values of $\gamma_i$ for each location can be provided as data, or estimated during model-fitting via an additional regression submodel against detection covariates. Since $\Lambda_i$ is only identified to within a multiplicative constant ($\alpha$ in Equation 2), the absolute value of $\gamma_i$ is not identified in this model, so any model for $\gamma_i$ should probably not have an intercept term. 

Notation:
\begin{align}
y_i &\sim Poisson(a_i\gamma_i\Lambda_i)
\end{align}

Code:
```{r ppm_obs}
distribution(y) <- poisson(a * gamma * Lambda)
```
Where `y` gives the number of presence-only records reported in cell $i$ and `a` and `gamma` are vectors giving the areas of the cells, and

## Integrated models

Specification of integrated models (those with multiple likelihoods for different datatypes) is simple, simply by using multiple `distribution()` statements. For example, a a combined presence-absence and abundance model might be defined as:

```{r integrated_obs}
p <- 1 - exp(-Lambda[pa_locations])
distribution(y_pa) <- bernoulli(p)
distribution(y_count) <- poisson(Lambda[count_locations])
```
Where `pa_locations` and `count_locations` are numeric indices to the sites with to presence-absence and count data respectively, and `y_pa` and `y_count` are the corresponding vectors of observed data.

# Abundance models

## Ricker model

The abundance relationship in the DSDM presented in the manuscript derives from the Beverton-Holt model, with the carrying capacity $K_i$ proportional to the intrinsic growth rate $\lambda_i$ minus one. This ensures that $K_i$ is zero if $\lambda_i = 1$ (no growth) and increases as lambda increases, though it has the unfortunate consequence that $K_i$ has negative values for $\lambda_i < 1$, which must be rectified in that model. An alternative abundance relationship approach, given in [@pagelForecastingSpeciesRanges2012], derives from the Ricker model and has a linear relationship between $K_i$ and $\lambda_i$, yielding a relative abundance expression that does not need rectifying. Though with large enough $\alpha$, this approach can yield large values of $\Lambda_i$ even if $\lambda_i$ is well below 1, in which  case the species should not be able to persist.

Notation:
\begin{align}
\Lambda_i &= \lambda_i \alpha \\ \nonumber
\lambda_i &= eigval(\mathbf{A_i})
\end{align}

Code:
```{r ricker_abundance}
analysis <- iterate_matrix(A)
lambda <- analysis$lambda
Lambda <- lambda * alpha
```

## Density-dependent vital rates

Both the Ricker and Beverton-Holt approaches to the abundance relationship assume that the carrying capacity can be expressed as some function of the intrinsic growth rate. This is convenient since the intrinsic growth rate is a well-studied and simple to compute quantity of a temporally-static transition matrix $A_i$. However, a more ecologically realistic approach is to explicitly model the vital rates as being density-dependent - that is having the survival probabilities or fecundity rates at a given time point depend on the population density at the previous time point. This enables incorporation of more detailed ecological knowledge about how vital rates drive abundance, which may be important to consider if the answer to the ecological question of interest depends on density dependence.

Density dependent vital rates can be incorporated in a DSDM by explicitly considering a vector $\mathbf{n}_{i,t}$ of population densities for each of $M$ life stages (indexed with $j$) at site $i$, at time $t$. $\mathbf{n}_{i,t}$ is evolved through time by multiplication against a timepoint-specific transition matrix $\mathbf{A}_{i,t}$, contructed of timepoint-specific vital rates that depend on the total population density (i.e. across all life stages $M$) in the previous time point $\mathbf{N}_{i,t}$. For example, these density-dependent relationships could be a linear function of population density (controlled by parameters $\alpha_F$ and $\alpha_S$) on the link-scale of the vital rates. Since the transition matrix is no longer temporally-static, the population dynamics cannot be summarised by a population growth rate. Instead, iteration of the matrix using the density-dependent vital rate functions causes the vector $\mathbf{n}_{i,t}$ of population densities to converge on a static value after a sufficient number of iterations, $T$. This terminal density can be used directly as the relative abundance. As in the basic DSDM, the parameters $\alpha_F$ and $\alpha_S$ control both density-dependence and the detection rate, since these two processes cannot be differentiated without population growth data.

Notation:
\begin{align}
\Lambda_i &=  \mathbf{n}_{i, T} \\ \nonumber
\mathbf{n}_{i,t+1} &= \mathbf{A}_{i,t+1} \mathbf{n}_{i,t} \\ \nonumber
\mathbf{A}_{i,t+1} &= \begin{bmatrix} F_{i,t} \cdot S_{Ji,t} & F_{i,t} \cdot S_{Ai,t} \\ S_{Ji,t} & S_{Ai,t}  \end{bmatrix}  \\ \nonumber
ln(F_{i,t}) &= \mathbf{X}_i \beta_F + \alpha_F \textstyle\sum_{j=1}^M{\mathbf{n}_{i,t,j}}\\ \nonumber
logit(S_{Ai,t}) &= \mathbf{X}_i \beta_S + \alpha_S \textstyle\sum_{j=1}^M{\mathbf{n}_{i,t,j}} \\ \nonumber
logit(S_{Ji,t}) &= logit(S_{Ai,t}) - \gamma
\end{align}

Code:
```{r vital_dd_abundance}
A_t_function <- function(state, iter, log_F, logit_S, alpha_F, alpha_S, gamma) {
  
  N <- rowSums(state)
  log_F_t <- base_log_F +  alpha_F * N
  logit_S_A_t <- base_logit_S + alpha_S * N
  
  F_t <- exp(log_F_t)
  S_A_t <- ilogit(logit_S_A_t)
  S_J_t <- ilogit(logit_S_A_t - gamma)

  top <- cbind(F_t * S_J_t, F_t * S_A_t)
  bottom <- cbind(S_J_t, S_A_t)
  A_t <- abind(top, bottom, along = 3)
  A_t
  
}

iterations <- iterate_dynamic_matrix(
  matrix_function = A_t_function, 
  base_log_F = X %*% beta_F,
  base_logit_S = X %*% beta_S,
  alpha_F = alpha_F,
  alpha_S = alpha_S,
  gamma = gamma
)

Lambda <- iterations$stable_population
```
Given additional scalar parameters `alpha_F` and `alpha_S`.

## Long-term temporal variation

Given temporally-indexed response data $y_{i,t}$, temporal variation in environmental conditions and therefore vital rates can be included in a DSDM in one of two ways. The applicability of each of these depends on both the temporal scale of the data (the period of time betwen the observations) and the demographics of the species.

If the length of time between observations is on the order of multiple generations opf the species population, it may be reasonable to assume that the observed population sixes are reflective of contemporary environmental conditions only, and not past fluctuations in environental conditions. In other words, that the population is at, or close to, the long-term carrying capacity of the species if the current environmental conditions were to be held static. In this situation, considering temporal change in environmental conditions is simply a matter of redifining the index $i$ in the basic DSDM to indeex unique combinations of time and site, instead of just site. The relative abundance parameter for each of these observations is therefore computed from the intrinsic growth rate of the transition matrix at the corresponding environmental conditions.

## Short-term temporal variation

Where the time period between observations is sufficiently short that the assumptions above are not met, or when the ecological question being answered requires it, temporal fluctuation in vital rates can instead be modelled by explicitly iterating the population through successive timesteps, at each time step using the corresponding transition matrix, as in the density-dependent vital rate model above. Instead of iterating for some arbitrrary number of iterations $T$ and taking the final state, instead the population is iterated over timesteps $t$ corresponding to time points in the dataset (and all intermediate timesteps). Thus the population at each timestep will be a function not only of the current environmental conditions, but of all previous environmental conditions - capturing the impacts of environmental stochasticity.

Under this formulation, the population size parameters $\mathbf{n}_{i,t}$ will be affected by the initial population state $\mathbf{n}_{i,0}$. this can either be introduced as an unknown parameter in the model, or set to an arbitrary value, and adding a sufficient 'burn-in' period prior to the first observation such that its value has no little effect on the estimated model parameters.

This model does not use static transition matrices and therefore cannot describe density dependence as a simple function of an intrinsic growth rate. It should therefore be combined with an explicit consideration of density-dependent vital rates as in the model above so that the population sizes $\mathbf{n}_{i,t}$ tend toward a long-term carrying capacity, rather than towards zero or infinity. 

Notation:
\begin{align}
y_{i,t} &\sim Bernoulli(p_{i,t}) \\ \nonumber
p_{i,t} &= 1 - e^{-\Lambda_{i,t}} \\ \nonumber
\Lambda_{i,t} &=  \mathbf{n}_{i,t} \\ \nonumber
\mathbf{n}_{i,t+1} &= \mathbf{A}_{i,t+1} \mathbf{n}_{i,t} \\ \nonumber
\mathbf{A}_{i,t+1} &= \begin{bmatrix} F_{i,t} \cdot S_{Ji,t} & F_{i,t} \cdot S_{Ai,t} \\ S_{Ji,t} & S_{Ai,t}  \end{bmatrix}  \\ \nonumber
ln(F_{i,t}) &= \mathbf{X}_{i,t} \beta_F + \alpha_F \textstyle\sum_{j=1}^M{\mathbf{n}_{i,t,j}}\\ \nonumber
logit(S_{Ai,t}) &= \mathbf{X}_{i,t} \beta_S + \alpha_S \textstyle\sum_{j=1}^M{\mathbf{n}_{i,t,j}} \\ \nonumber
logit(S_{Ji,t}) &= logit(S_{Ai,t}) - \gamma
\end{align}

Note that this notation is very similar to the density-dependent vital rate model, except that both the observation model (the first three lines) and the design matrix $\mathbf{X}$ are temporally-indexed, and the relative abundances $\Lambda_{i,t}$ are given by the contemporary population sizes, not the terminal sizes.

Code:
```{r short_term_temporal}
A_t_function <- function(state, iter, X, beta_F, beta_S, alpha_F, alpha_S, gamma) {
  
  N <- rowSums(state)
  log_F_t <- X %*% beta_F +  alpha_F * N
  logit_S_A_t <- X %*% beta_S + alpha_S * N
  
  F_t <- exp(log_F_t)
  S_A_t <- ilogit(logit_S_A_t)
  S_J_t <- ilogit(logit_S_A_t - gamma)

  top <- cbind(F_t * S_J_t, F_t * S_A_t)
  bottom <- cbind(S_J_t, S_A_t)
  A_t <- abind(top, bottom, along = 3)
  A_t
  
}

iterations <- iterate_dynamic_matrix(
  matrix_function = A_t_function, 
  initial_state = n_init,
  niter = timesteps,
  X = X_list,
  beta_F = beta_F,
  beta_S = beta_S,
  alpha_F = alpha_F,
  alpha_S = alpha_S,
  gamma = gamma
)

Lambda <- iterations$all_states
p <- 1 - exp(-Lambda)
distribution(y) <- bernoulli(p)
```
Given: `X_list` a list of length $T$ of design matrices for each of the time points, `n_init` is the initial population state, and `y` is an $N$x$T$ matrix of presence-absence at each timestep and site, and `timesteps` is the value of $T$.

# Population dynamic models

## Integral projection models

<to do, need to package up inteegration code into greta.dynamics?>

## Biotic interactions

<to do, just add multiple life stages>

Need iternatactions to be via density-dependent effects, because we can't have negative elements in the matrix?

## Dispersal with a static transition matrix

Dispersal of individuals between sites can be incorporated by expanding the matrix population model to simultaneously consider populations in all patches, with dispersal between patches quantified by a dispersal kernel.

In previous models, which assumed sites to be independent of one another with respect to their population dynamics, the 3D $N$x$M$x$M$ array $A$ contained the $M$x$M$ transition matrices $\mathbf{A}_i$ for each of the $N$ sites $i$. To consider interacting population dynamics across sites, we instead consider a single, larger transition matrix $\mathbf{A}^*$ with dimension $NM$x$NM$, with a symmetric blocked structure. The the $i$^{th} block-diagonal element of $\mathbf{A}^*$ is the site-specific $M$x$M$ population transition matrix $\mathbf{A}_i$ and the off-diagonal blocks are $M$x$M$ diagonal matrices with diagonal entries giving the probability $d_{j,i,i'}$ that an individual of life stage $j$ in site $i$ will move to site $i'$ in this timestep. $d_{j,i,i'}$ is computed using a dispersal kernel (an exponential kernel in this example) with stage-specific dispersal ability parameter $\tau_j$, standardised to sum to 1 over the study area and ensure $d_{j,i,i'}$ is a valid probability.

By connecting the populations at all sites with immigration and emigration potential, we now have a single intrinsic growth rate for the entire population rather than for th eopulation at each site. Rather than computing the relative abundance at each site $\Lambda_i$ as a function of an intrinsic growth rate, we can instead sum stable stage distributions over the stages in each site to yeild a stable population distribution over sites. $\Lambda_i$ can therefore be computed as proportional (with constant $\alpha$) to this relative population size.

In practice, the matrix $\mathbf{A}^*$ can be very sparse: the proportion of non-zero elements is $(M + N - 1) / (MN)$; as N increases, the proportion of non-zero approaches $1/M$. This sparsity can be increased further by setting an upper dispersal limit, beyond which $d_{j,i,i'}$ is set to zero, or by limiting the number of stages that can disperse. It is therefore computationally advantageous to compute the dominant eigenvector using sparse matrix methods, such as cumputtion by iteration using sparse matrix multiplication.

Notation:
\begin{align}
\Lambda_i &= \alpha v_i / \textstyle\sum_{i=1}^{N}{v_{i}} \\ \nonumber
v_i &= \textstyle\sum_{j=1}^{M}{v^*_{j+(i-1)}} \\ \nonumber
v^* &= eigvec(\mathbf{A}^*) \\ \nonumber
\mathbf{A}^* &= \begin{bmatrix} \mathbf{A}_1 & \mathbf{M}_{1,2} & \dots & \mathbf{M}_{1,i'} & \dots & \mathbf{M}_{1,N}\\
\mathbf{M}_{2,1} & \mathbf{A}_2 & \dots & \mathbf{M}_{2,i'} & \dots & \mathbf{M}_{2,N} \\
\vdots & \vdots & \ddots & \vdots & &  \vdots \\
\mathbf{M}_{i,1} & \mathbf{M}_{i,2} & \dots & \mathbf{A}_i & \dots & \mathbf{M}_{i,N} \\
\vdots & \vdots &  & \vdots & \ddots & \vdots \\
\mathbf{M}_{N,1} & \mathbf{M}_{N,2} & \dots & \mathbf{M}_{N,i'} & \dots & \mathbf{A}_N \end{bmatrix} \\ \nonumber
\mathbf{M}_{i,i'} &= diag(d_{1,i,i'}, \dots, d_{j,i,i'}, \dots, d_{M,i,i'}) \\ \nonumber
d_{j,i,i'} &= d^*_{j,i,i'} / \textstyle\sum_{i=1}^Nd^*_{j,i,i'} \\ \nonumber
d^*_{j,i,i'} &=  e^{-\tau_j \mathbf{D}_{i,i'}}
\end{align}

Code:


## Dispersal with density-dependent vital rates

<to do, two matrix multiplications (mention sparsity) can only be done with density-dependent vital rates>

Or do it with static analysis and stable size distribution for relative abundances?


The order of the dispersal and population transition iterations can be reversed if pre-breeding migration is required.

Notation:
\begin{align}
\mathbf{n}_{j,t+1} &= \mathbf{M}_j \mathbf{n}^*_{j,t} \\ \nonumber
\mathbf{n}^*_{i,t+1} &= \mathbf{A}_{i,t+1} \mathbf{n}_{i,t}
\mathbf{M}_j &= exp(-\tau_j \mathbf{D})
\end{align}



Code:


# References
